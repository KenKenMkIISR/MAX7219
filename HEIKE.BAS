REM 8x32 Character Font
REM to 8x64 LED Matrix (MAX7219)
REM with Brightness

FOPEN "HEIKE3.BMP","r"
FSEEK 22
H=FGETC():H=H+FGETC()*256
PRINT H
USEVAR PAL
USEVAR VRAM,CNT,FLG
USEVAR D1,D2,D3,D4

DIM B(H*8/4),PAL(15)
DIM VRAM(8*64/4)
DIM G(3)
G(0)=0:G(1)=4:G(2)=8:G(3)=14

FSEEK 54
FOR I=0 TO 15
 PAL(I)=FGETC():D=FGETC():D=FGETC():D=FGETC()
NEXT

FOR I=H-1 TO 0 STEP -1
 FOR J=0 TO 3
  D=FGETC()
  POKE B+I*8+J*2,PAL(D/16)/16
  POKE B+I*8+J*2+1,PAL(D%16)/16
 NEXT
NEXT
FCLOSE

SYSTEM 200,0
CNT=0
USETIMER 700
INTERRUPT TIMER,PUTLED


SPI 10000,16,0:REM 10MHz/16bit/Mode0
SPIWRITE $0C01,$0C01,$0C01,$0C01,$0C01,$0C01,$0C01,$0C01:REM Not Shutdown Mode
SPIWRITE $0900,$0900,$0900,$0900,$0900,$0900,$0900,$0900:REM No Decode Mode
SPIWRITE $0A0F,$0A0F,$0A0F,$0A0F,$0A0F,$0A0F,$0A0F,$0A0F:REM Set Briteness
SPIWRITE $0B07,$0B07,$0B07,$0B07,$0B07,$0B07,$0B07,$0B07:REM Scan All LEDs

DO
 FOR Y=-252 TO H-1
  FLG=0:WHILE FLG<2:IDLE:WEND
  P=B+Y*8
  Q=VRAM
  FOR I=0 TO 63
   IF P>=B AND P<B+H*8 THEN
    POKE32 Q,PEEK32(P)
    POKE32 Q+4,PEEK32(P+4)
   ELSE
    POKE32 Q,0
    POKE32 Q+4,0
   ENDIF
   P=P+32:Q=Q+8
  NEXT
 NEXT
LOOP

LABEL PUTLED
 VAR I,J,P
 P=VRAM+7
 FOR I=1 TO 8
  FOR J=0 TO 15
   D1=D1<<1
   IF PEEK(P) > G(CNT) THEN D1=D1+1
   P=P+8
  NEXT
  FOR J=0 TO 15
   D2=D2<<1
   IF PEEK(P) > G(CNT) THEN D2=D2+1
   P=P+8
  NEXT
  FOR J=0 TO 15
   D3=D3<<1
   IF PEEK(P) > G(CNT) THEN D3=D3+1
   P=P+8
  NEXT
  FOR J=0 TO 15
   D4=D4<<1
   IF PEEK(P) > G(CNT) THEN D4=D4+1
   P=P+8
  NEXT
  P=P-513
  SPIWRITE (I<<8)+((D1>>8) AND $FF),(I<<8)+(D1 AND $FF),(I<<8)+((D2>>8) AND $FF),(I<<8)+(D2 AND $FF),(I<<8)+((D3>>8) AND $FF),(I<<8)+(D3 AND $FF),(I<<8)+((D4>>8) AND $FF),(I<<8)+(D4 AND $FF)
 NEXT
 CNT=CNT+1:IF CNT=4 THEN CNT=0:FLG=FLG+1
RETURN
