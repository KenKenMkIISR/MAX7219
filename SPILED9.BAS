REM SPI LED Matrix x8 (MAX7219 LED Driver)
REM 64x8 VRAM
REM Golden Fish

USEVAR VRAM,D0,D1,D2,D3,D4,D5,D6,D7

SPI 10000,16,0:REM 10MHz/16bit/Mode0

REM Not Test Mode
D=$0F00:SPIWRITE D,D,D,D,D,D,D,D

REM Not Shutdown Mode
D=$0C01:SPIWRITE D,D,D,D,D,D,D,D

REM No Decode Mode
D=$0900:SPIWRITE D,D,D,D,D,D,D,D

REM Set Briteness
D=$0A05:SPIWRITE D,D,D,D,D,D,D,D

REM Scan All LEDs
D=$0B07:SPIWRITE D,D,D,D,D,D,D,D

REM Read data
DIM VRAM(2*8-1),P(24+24+24+12-1)
RESTORE FONT
FOR I=0 TO 23:P(I)=READ():NEXT
FOR I=0 TO 23:P(I+48)=READ():NEXT
FOR I=0 TO 11:P(I+72)=READ():NEXT

REM Mirror data
FOR I=0 TO 23
 D=P(I)>>16:E=0
 FOR J=1 TO 16
  E=(E<<1)+(D AND 1):D=D>>1
 NEXT
 P(I+24)=E<<16
NEXT

REM SYSTEM 200,0:REM Video OFF
A=-1:REM Bubble y
Y=0:REM Fish y
W=1:REM Fish y up/down
F=0:REM Fish font pattern number(0-2)
K=0:REM Crab x
L=1:REM Crab direction

REM Main loop
DO
 FOR X=70 TO -20 STEP -1
  GOSUB SBMPMN,5,0,7,8,P+48*4+F*32
  GOSUB SBMPMN,23,0,7,8,P+48*4+((F+2)%3)*32
  GOSUB SBMPMN,42,0,7,8,P+48*4+((F+1)%3)*32
  GOSUB SBMPMN,K,2,10,6,P+72*4+(K AND 1)*24
  GOSUB SBMPMN,X,Y,16,8,P+F*32
  IF A>=0 THEN GOSUB SETP,B,A
  GOSUB PUTLED
  WAIT 6
  GOSUB CBMPMN,X,Y,16,8
  GOSUB CBMPMN,K,2,10,6
  IF A>=0 THEN GOSUB CLRP,B,A:A=A-1
  IF X AND 1 THEN F=(F+1)%3
  IF (X AND 3)=0 THEN Y=Y+W
  IF Y<-1 THEN W=1 ELSE IF Y>1 THEN W=-1:A=7:B=X-8
  IF (X AND 7)=2 THEN K=K+L
  IF K=0 THEN L=1 ELSE IF K=54 THEN L=-1
 NEXT

 FOR X=-20 TO 70
  GOSUB SBMPMN,5,0,7,8,P+48*4+F*32
  GOSUB SBMPMN,23,0,7,8,P+48*4+((F+2)%3)*32
  GOSUB SBMPMN,42,0,7,8,P+48*4+((F+1)%3)*32
  GOSUB SBMPMN,K,2,10,6,P+72*4+(K AND 1)*24
  GOSUB SBMPMN,X,Y,16,8,P+(F+3)*32
  IF A>=0 THEN GOSUB SETP,B,A
  GOSUB PUTLED
  WAIT 6
  GOSUB CBMPMN,X,Y,16,8
  GOSUB CBMPMN,K,2,10,6
  IF A>=0 THEN GOSUB CLRP,B,A:A=A-1
  IF X AND 1 THEN F=(F+1)%3
  IF (X AND 3)=0 THEN Y=Y+W
  IF Y<-1 THEN W=1 ELSE IF Y>1 THEN W=-1:A=7:B=X+24
  IF (X AND 7)=2 THEN K=K+L
  IF K=0 THEN L=1 ELSE IF K=54 THEN L=-1
 NEXT
LOOP

REM SYSTEM 200,1:REM Video ON
END

LABEL SBMPMN
 REM Set bitmap size MxN
 REM arg1:x,arg2:y,arg3:M,arg4:N,arg5:bitmap
 VAR I,J,D
 FOR I=0 TO ARGS(4)-1
  D=PEEK32(ARGS(5)+I*4)
  FOR J=0 TO ARGS(3)-1
   IF D AND $80000000 THEN
    GOSUB SETP,ARGS(1)+J,ARGS(2)+I
   ELSE
    GOSUB CLRP,ARGS(1)+J,ARGS(2)+I
   ENDIF
   D=D<<1
  NEXT
 NEXT
RETURN

LABEL CBMPMN
 REM Clear bitmap size MxN
 REM arg1:x,arg2:y,arg3:M,arg4:N
 VAR I,J
 FOR I=0 TO ARGS(4)-1
  FOR J=0 TO ARGS(3)-1
   GOSUB CLRP,ARGS(1)+J,ARGS(2)+I
  NEXT
 NEXT
RETURN

LABEL CLRVRM
 REM Clear VRAM all
 VAR I
 FOR I=0 TO 15:VRAM(I)=0:NEXT
RETURN

LABEL SETP
 REM Set point (arg1,arg2)
 VAR P
 IF ARGS(1)<0 OR ARGS(1)>=64 THEN RETURN
 IF ARGS(2)<0 OR ARGS(2)>=8 THEN RETURN
 P=(ARGS(2)<<1)+(ARGS(1)>>5)
 VRAM(P)=VRAM(P) OR (1<<(31-(ARGS(1) AND $1F)))
RETURN

LABEL CLRP
 REM Clear point (arg1,arg2)
 VAR P
 IF ARGS(1)<0 OR ARGS(1)>=64 THEN RETURN
 IF ARGS(2)<0 OR ARGS(2)>=8 THEN RETURN
 P=(ARGS(2)<<1)+(ARGS(1)>>5)
 VRAM(P)=VRAM(P) AND ((1<<(31-(ARGS(1) AND $1F))) XOR -1)
RETURN

LABEL PUTLED
 REM Output VRAM to LED
 VAR I,Y
 FOR I=0 TO 7
  Y=(I+1)<<8
  D0=Y+((VRAM(I*2  )>>24) AND $FF)
  D1=Y+((VRAM(I*2  )>>16) AND $FF)
  D2=Y+((VRAM(I*2  )>> 8) AND $FF)
  D3=Y+((VRAM(I*2  )    ) AND $FF)
  D4=Y+((VRAM(I*2+1)>>24) AND $FF)
  D5=Y+((VRAM(I*2+1)>>16) AND $FF)
  D6=Y+((VRAM(I*2+1)>> 8) AND $FF)
  D7=Y+((VRAM(I*2+1)    ) AND $FF)
  SPIWRITE D0,D1,D2,D3,D4,D5,D6,D7
 NEXT
RETURN

LABEL FONT
REM Golden Fish 16x8 x3 patterns
DATA $1E060000,$3F1E0000,$7FBE0000,$DFF00000
DATA $FFE00000,$7FFE0000,$3F9F0000,$0EC00000
DATA $1E020000,$3F1F0000,$7FBE0000,$DFFC0000
DATA $FFE00000,$7FF00000,$3FDE0000,$0E670000
DATA $1E000000,$3F0F0000,$7F9F0000,$DFFC0000
DATA $7FE00000,$FFF80000,$3FDF0000,$0E670000

REM Plants 7x8 x3 patterns
DATA $88000000,$84000000,$54000000,$54000000
DATA $68000000,$50000000,$20000000,$20000000
DATA $54000000,$54000000,$4C000000,$58000000
DATA $70000000,$50000000,$20000000,$20000000
DATA $92000000,$54000000,$6C000000,$28000000
DATA $70000000,$50000000,$20000000,$20000000

REM Crab 10x6 x2 patterns
DATA $12000000,$BF400000,$7F800000,$BF400000
DATA $7F800000,$A1400000
DATA $92400000,$7F800000,$BF400000,$7F800000
DATA $BF400000,$52800000
